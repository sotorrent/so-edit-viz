<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">

    <title>SOEditViz</title>

    <link rel="stylesheet" type="text/css" href="global.css"/>

    <script src="lib/d3.js"></script>
    <script src="global.js"></script>
</head>
<body>

<div class="header">
    <label for="post_id">Post ID: </label>
    <input type="number" id="post_id"/>
    <button type="button" id="load">Load</button>
    <div class="divider"></div>
    <button type="button" id="previous">< Previous</button>
    <button type="button" id="next">Next ></button>
</div>

<svg></svg>

<script>
    var gridWidth = 85;
    var postIds = [];
    var currentIndex = -1;
    var loadButton = d3.select("#load");
    var nextButton = d3.select("#next");
    var previousButton = d3.select("#previous");

    function updateThread() {
        // clear SVG
        d3.select("svg").selectAll("*").remove();
        // load data
        loadThread(postIds[currentIndex]);
        document.getElementById("post_id").value = postIds[currentIndex];
        // update buttons
        if (currentIndex < postIds.length-1) {
            nextButton.attr("disabled", null);
        } else {
            nextButton.attr("disabled", "disabled");
        }
        if (currentIndex > 0) {
            previousButton.attr("disabled", null);
        } else {
            previousButton.attr("disabled", "disabled");
        }
    }

    function nextThread() {
        if (currentIndex < postIds.length - 1) {
            currentIndex++;
            updateThread();
        }
    }

    function previousThread() {
        if (currentIndex > 0) {
            currentIndex--;
            updateThread();
        }
    }

    // register event handlers
    loadButton.on("click", function() {
            var postId = parseInt(document.getElementById("post_id").value);
            var index = postIds.indexOf(postId);
            if (index > -1) {
                currentIndex = index;
                updateThread();
            } else {
                alert("No data for post ID " + postId + " found.");
            }
        });
    nextButton.on("click", nextThread);
    previousButton.on("click", previousThread);

    function loadThread(postId) {
        readCSV(postId, function(data) {
            // retrieve posts and assign index (question has always index 0, answers index >0)
            var posts = retrievePosts(data);

            // retrieve question id
            var questionId = data.find(function(row) {return row.PostTypeId === 1;}).PostId;

            // retrieve timestamps for x axis
            var timestamps = retrieveTimestampsDate(data);

            // get x and y coordinates
            var coordinates = getCoordinates(data, posts);

            // configure svg element
            var maxX = (data.length + 1) * gridWidth;
            var maxY = Object.keys(posts).length * gridHeight;
            configureSVG(maxX, maxY);
            var group = d3.select("#mainGroup");

            // append the tooltip div
            var tooltip = d3.select("body")
                .append("div")
                .attr("class", "tooltip")
                .style("opacity", 0);

            // draw grid
            drawGrid(group, timestamps, maxY, gridWidth);

            // draw y axis
            drawYAxis(group, posts);

            // draw x axes;
            drawXAxis(group, timestamps, maxY, gridWidth);

            function getPixelCoordinateX(coordinate) {
                return (coordinate + 1) * gridWidth;
            }
            function getPixelCoordinateY(coordinate) {
                return (coordinate + 1) * gridHeight;
            }
            var dataPoints = group.append("g");

            // draw polyline connecting data points
            var polyLine = "";
            coordinates.forEach(function(coordinate, index) {
                if (index > 0) {
                    polyLine += " ";
                }
                polyLine += getPixelCoordinateX(coordinate[0]) + "," + getPixelCoordinateY(coordinate[1]);
            });
            dataPoints.append("polyline")
                .attr("points", polyLine)
                .attr("fill", "none")
                .attr("stroke", "lightgray")
                .attr("stroke-width", lineStroke);

            // draw data points
            dataPoints.selectAll("circle")
                .data(coordinates)
                .enter()
                .append("circle")
                .attr("cx", function(coordinate) {
                    return getPixelCoordinateX(coordinate[0]);
                })
                .attr("cy", function(coordinate) {
                    return getPixelCoordinateY(coordinate[1]);
                })
                .attr("r", circleRadius)
                .attr("fill", function(coordinate) {
                    var row = coordinate[2];
                    if (row.Event === "Comment") {
                        return "mediumaquamarine ";
                    } else {
                        return "skyblue";
                    }
                })
                .attr("stroke", function(coordinate) {
                    var row = coordinate[2];
                    if (row.UserId === posts[row.PostId].OwnerId) {
                        if (row.Event === "Comment") {
                            return "#078C5F";
                        } else {
                            return "#0F5A78";
                        }
                    } else {
                        return "tomato";
                    }
                })
                .attr("stroke-width", circleStroke)
                .on("mouseover", function(coordinate) {
                    tooltip
                        .transition()
                        .duration(50)
                        .style("opacity", 0.9);
                    tooltip
                        .html(extractDateAndTimeString(coordinate[2].CreationDate))
                        .style("left", (d3.event.pageX) + "px")
                        .style("top", (d3.event.pageY - 18) + "px");
                })
                .on("mouseout", function() {
                    tooltip
                        .transition()
                        .duration(50)
                        .style("opacity", 0.0);
                });

            function getCommentUrl(questionId, commentId, postId) {
                return "https://stackoverflow.com/q/" + questionId + "#comment" + commentId + "_" + postId;
            }

            function getRevisonsUrl(postId) {
                return "https://stackoverflow.com/posts/" + postId + "/revisions";
            }

            dataPoints.selectAll("a")
                .data(coordinates)
                .enter()
                .append("a")
                .attr("xlink:href",  function(coordinate) {
                    var row = coordinate[2];
                    if (row.Event === "Comment") {
                        return getCommentUrl(questionId, row.EventId, row.PostId);
                    } else {
                        return getRevisonsUrl(row.PostId);
                    }
                })
                .attr("target", "_blank")
                .append("text")
                .attr("text-anchor", "middle")
                .attr("alignment-baseline", "central") // Chrome
                .attr("dominant-baseline", "central") // Firefox
                .attr("class", "event")
                .attr("x", function(coordinate) {
                    return getPixelCoordinateX(coordinate[0]);
                })
                .attr("y", function(coordinate) {
                    return getPixelCoordinateY(coordinate[1]);
                })
                .text(function(coordinate) {
                    var row = coordinate[2];

                    if (row.Event === "InitialBody") { // includes "InitialTitle", which is ignored (see readCSV())
                        return "I";
                    } else if (row.Event === "BodyEdit") {
                        return "E";
                    } else if (row.Event === "TitleEdit") {
                        return "TE";
                    } else if (row.Event === "Comment") {
                        return "C";
                    } else {
                        return "X";
                    }
                });
        });
    }

    // read available post ids
    d3.csv("data/index.csv", function (row) {
        return {
            PostId: parseInt(row.PostId)
        }
    }).then(function(data) {
        postIds = data.map(function(row) { return row.PostId; });

        // configure button
        previousButton.attr("disabled", "disabled");
        if (postIds.length === 0) {
            nextButton.attr("disabled", "disabled");
        }

        // open first thread on startup
        nextThread();
    });
</script>

</body>
</html>