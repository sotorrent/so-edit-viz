<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">

    <title>SOEditViz</title>

    <script src="lib/d3.js"></script>

    <style>
        text {
            font-size: 14px;
            font-family: sans-serif;
        }
    </style>
</head>
<body>

<script charset="UTF-8">
    var gridWidth = 80;
    var gridHeight = 40;
    var gridShift = 40;
    var circleRadius = 5;
    var margin = {top: 40, right: 40, bottom: 40, left: 100};

    d3.csv("data/3758880.csv", function (row) {
        return {
            PostId: parseInt(row.PostId),
            PostTypeId: parseInt(row.PostTypeId),
            EventId: parseInt(row.EventId),
            Event: row.Event,
            UserId: parseInt(row.UserId),
            CreationDate: new Date(row.CreationDate)
        }
    }).then(function(data) {
        data.sort(function(row1, row2) {
            return row1.CreationDate - row2.CreationDate;
        });

        // retrieve posts and assign index (question has always index 0, answers index >0)
        var posts = {};
        data
            .filter(function(row) {return row.Event === "InitialBody";})
            .map(function(row) {return {
                PostId: row.PostId,
                PostTypeId: row.PostTypeId,
                InitialAuthor: row.UserId,
                CreationDate: row.CreationDate
            }})
            .forEach(function(post, index) {
                post["Index"] = index;

                if (post.PostTypeId === 1) {
                    post["SOId"] = "q/" + post.PostId;
                } else if (post.PostTypeId === 2) {
                    post["SOId"] = "a/" + post.PostId;
                }

                posts[post.PostId] = post;
        });

        // retrieve timestamps for x axis
        var timestamps = data.map(function(row) { return row.CreationDate.toISOString().split('T')[0]; });

        // get x and y coordinates
        var coordinates = [];
        data.forEach(function(row, index) {
            var xPos = index;
            var yPos = posts[row.PostId].Index;
            coordinates.push([xPos, yPos]);
        });

        // create svg element
        var maxX = (data.length+1) * gridWidth;
        var maxY = Object.keys(posts).length * gridHeight;
        var svg = d3.select("body")
            .append("svg")
            .attr("width", maxX + margin.left + margin.right)
            .attr("height", maxY + margin.top + margin.bottom);

        // group for drawing area
        var g = svg.append("g")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

        // draw grid
        var grid = g.append("g");
        grid.selectAll("line")
            .data(timestamps)
            .enter()
            .append("line")
            .attr("x1", function(timestamp, index) {
                return (index+1) * gridWidth - gridShift;
            })
            .attr("y1", -15)
            .attr("x2", function(timestamp, index) {
                return (index+1) * gridWidth - gridShift;
            })
            .attr("y2", maxY - 10)
            .attr("stroke", function(timestamp, index) {
                if (index === 0 || timestamps[index] !== timestamps[index-1]) {
                    return "LightGray";
                } else {
                    return "white";
                }
            })
            .attr("stroke-width", 2);

        // create y axis
        var yAxis = g.append("g");
        yAxis.selectAll("a")
            .data(Object.keys(posts))
            .enter()
            .append("a")
            .attr("xlink:href",  function(post_id) {
                return "https://stackoverflow.com/" + posts[post_id].SOId;
            })
            .attr("target", "_blank")
            .append("text")
            .attr("text-anchor", "end")
            .attr("alignment-baseline", "central")
            .attr("x", 0)
            .attr("y", function(post_id) {
                return posts[post_id].Index * gridHeight;
            })
            .text(function(post_id) {
                return posts[post_id].SOId;
            });

        // create x axis;
        var xAxis = g.append("g");
        xAxis.selectAll("text")
            .data(timestamps)
            .enter()
            .append("text")
            .attr("text-anchor", "middle")
            .attr("alignment-baseline", "central")
            .attr("x", function(timestamp, index) {
                return (index+1) * gridWidth - gridShift;
            })
            .attr("y", maxY)
            .text(function(timestamp, index) {
                if (index === 0 || timestamps[index] !== timestamps[index-1]) {
                    return timestamp;
                } else {
                    return "";
                }
            });

        // draw data points
        function getPixelCoordinateX(coordinate) {
            return (coordinate+1) * gridWidth;
        }
        function getPixelCoordinateY(coordinate) {
            return coordinate * gridHeight;
        }
        var dataPoints = g.append("g");
        dataPoints.selectAll("circle")
            .data(coordinates)
            .enter()
            .append("circle")
            .attr("cx", function(coordinate) {
                return getPixelCoordinateX(coordinate[0]);
            })
            .attr("cy", function(coordinate) {
                return getPixelCoordinateY(coordinate[1]);
            })
            .attr("r", circleRadius);

        // connect data points
        var polyline = "";
        coordinates.forEach(function(coordinate, index) {
            if (index > 0) {
                polyline += " ";
            }
            polyline += getPixelCoordinateX(coordinate[0]) + "," + getPixelCoordinateY(coordinate[1]);
        });
        dataPoints.append("polyline")
            .attr("points", polyline)
            .attr("fill", "none")
            .attr("stroke", "black")
            .attr("stroke-width", 2);

        //var width = svg.attr("width") - margin.left - margin.right;
        //var height = svg.attr("height") - margin.top - margin.bottom;
        //

        // d3.select("body")
        //     .selectAll("div")
        //     .data(posts)
        //     .enter().append("div")
        //     .text(function(row) {
        //         return row.PostId + "(" + row.PostTypeId + ", " + row.CreationDate + ")";
        //     });
        }
    );
</script>

</body>
</html>