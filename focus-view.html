<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">

    <title>SOEditViz</title>

    <link rel="stylesheet" type="text/css" href="global.css"/>

    <script src="lib/d3.js"></script>
    <script src="global.js"></script>
</head>
<body>

<svg></svg>

<script>
    var gridWidth = 5;
    var gridStep = 60;
    var queryParameters = [];
    window.location.search.substr(1).split("&").forEach(function(keyValueString) {
        var keyValue = keyValueString.split("=");
        queryParameters[keyValue[0]] = keyValue[1];
    });

    if (!Object.keys(queryParameters).includes("postId") || !Object.keys(queryParameters).includes("eventId")) {
        errorMessage("Query parameter postId or eventId is missing.");
    }

    var postId = parseInt(queryParameters["postId"]);
    var eventId = parseInt(queryParameters["eventId"]);

    readCSV(postId, function(data) {
        var event = data.find(function(row) { return row.EventId === eventId; });

        if (event == null) {
            errorMessage("Event not found.");
        }

        // retrieve posts and assign index (question has always index 0, answers index >0)
        var posts = retrievePosts(data);

        // retrieve question id
        var questionId = retrieveQuestionId(data);

        // filter events
        var minute = 60000;
        var hour = 60 * minute;
        var minTimestamp = event.CreationDate.getTime() - 12*hour;
        var maxTimestamp = event.CreationDate.getTime() + 12*hour;
        data = data.filter(
            function(row) {
                return row.CreationDate.getTime() >= minTimestamp
                    && row.CreationDate <= maxTimestamp;
            }
        );

        // filter posts
        var filteredPostIds = data.map(function(event) { return event.PostId; }).filter(onlyUnique);

        // retrieve timestamps for x axis
        minTimestamp = data[0].CreationDate;
        maxTimestamp = data[data.length-1].CreationDate;

        var timestamps = [];
        for (var i = minTimestamp.getTime()-minute; i <= maxTimestamp.getTime()+minute; i+=minute) {
            timestamps.push(getTimestampsDateAndTime(new Date(i)));
        }

        // configure svg element
        var maxX = gridAxisWidth + timestamps.length * gridWidth;
        var maxY = Object.keys(posts).length * gridHeight;
        configureSVG(maxX, maxY);
        var group = d3.select("#mainGroup");

        drawGrid(group, timestamps, maxY, gridWidth, gridStep);
        drawYAxis(group, posts, filteredPostIds);
        drawXAxis(group, timestamps, maxY, gridWidth, gridStep);

        var coordinates = getCoordinatesContinuous(data, posts, timestamps);

        drawPolyLine(group, coordinates, gridWidth);
        drawDataPoints(group, coordinates, posts, questionId, gridWidth, false);
    });
</script>

</body>
</html>